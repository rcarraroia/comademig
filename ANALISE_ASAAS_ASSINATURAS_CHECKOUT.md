# üîç AN√ÅLISE: ASAAS ASSINATURAS vs IMPLEMENTA√á√ÉO ATUAL

**Data:** 11/01/2025  
**Objetivo:** Comparar fluxo correto do Asaas com implementa√ß√£o atual

---

## üìö DOCUMENTA√á√ÉO ASAAS - PONTOS CR√çTICOS

### 1. ASSINATURAS (Recorr√™ncia)

**Fonte:** `docs/asaas_documentacao_completa/asaas_docs/referencia_reference/introdu√ß√£o.md`

#### Conceito:
> "Assinaturas devem ser utilizadas quando a cobran√ßa √© feita periodicamente de forma recorrente"

#### Diferen√ßa Cr√≠tica:
- **Assinatura:** Cria UMA cobran√ßa por vez, automaticamente a cada per√≠odo
- **Parcelamento:** Cria TODAS as parcelas de uma vez

#### Comportamento com Cart√£o:
- **Assinatura:** Nova transa√ß√£o a cada m√™s no cart√£o
- **Parcelamento:** Valor total cobrado de uma vez, parcelado

#### Gera√ß√£o de Cobran√ßas:
> "Cobran√ßas recorrentes pertencentes a uma assinatura s√£o geradas **40 dias antes** do vencimento"

**Exemplo:**
- Assinatura criada hoje com vencimento em 5 dias
- Sistema j√° cria 2 cobran√ßas:
  - 1¬™ cobran√ßa: vence em 5 dias
  - 2¬™ cobran√ßa: vence em 35 dias (5 + 30)

#### Webhooks:
> "Asaas n√£o possui webhooks pr√≥prios para assinaturas, apenas das cobran√ßas"

- Webhook: `PAYMENT_CREATED` cont√©m `subscription` id
- Gerenciar via webhooks de cobran√ßa, n√£o de assinatura

---

### 2. ASAAS CHECKOUT (Checkout Transparente)

**Fonte:** `docs/asaas_documentacao_completa/asaas_docs/guias_docs/asaas_checkout.md`

#### Conceito:
> "Formul√°rio pronto para usar no fechamento de vendas digitais"

#### Vantagens:
- ‚úÖ F√°cil implementa√ß√£o
- ‚úÖ M√∫ltiplas op√ß√µes de pagamento (PIX, Cart√£o)
- ‚úÖ Suporta: √† vista, parcelado OU assinatura
- ‚úÖ Tempo de expira√ß√£o configur√°vel
- ‚úÖ Dados do cliente pr√©-preenchidos
- ‚úÖ Imagem e detalhes do produto
- ‚úÖ Redirecionamento ap√≥s conclus√£o
- ‚úÖ Suporta split de pagamentos

---

## üîç AN√ÅLISE DA IMPLEMENTA√á√ÉO ATUAL

### M√≥dulo: Solicita√ß√£o de Servi√ßos (‚úÖ CORRETO)

**Arquivo:** `src/pages/dashboard/CheckoutServico.tsx`

#### Fluxo Implementado:
```
1. Usu√°rio seleciona servi√ßo
   ‚Üì
2. Preenche formul√°rio de exig√™ncias
   ‚Üì
3. Redireciona para CheckoutServico
   ‚Üì
4. Preenche dados do cliente
   ‚Üì
5. Escolhe forma de pagamento (PIX ou Cart√£o)
   ‚Üì
6. Hook useCheckoutTransparente processa:
   - Cria cliente no Asaas
   - Cria cobran√ßa √∫nica (n√£o assinatura)
   - Processa pagamento
   ‚Üì
7. Se PIX: Mostra QR Code
   Se Cart√£o: Redireciona para sucesso
```

#### Caracter√≠sticas:
- ‚úÖ Checkout transparente (formul√°rio pr√≥prio)
- ‚úÖ Suporta PIX e Cart√£o
- ‚úÖ Desconto PIX (5%)
- ‚úÖ Parcelamento em cart√£o
- ‚úÖ Cria cobran√ßa √öNICA (n√£o recorrente)
- ‚úÖ Usu√°rio J√Å EST√Å LOGADO

**Tipo de cobran√ßa:** √öNICA (n√£o √© assinatura)

---

### M√≥dulo: Filia√ß√£o (‚ùå INCORRETO)

**Arquivo:** `src/pages/Filiacao.tsx` + `src/hooks/useFiliacaoPayment.ts`

#### Fluxo Atual (ERRADO):
```
1. Usu√°rio acessa /filiacao (SEM login)
   ‚Üì
2. Seleciona tipo de membro
   ‚Üì
3. Clica em "Prosseguir"
   ‚Üì
4. ‚ùå Sistema verifica if (!user) ‚Üí BLOQUEIA
   ‚Üì
5. ‚ùå Tenta redirecionar para /login (404)
   ‚Üì
6. PROCESSO INTERROMPIDO
```

#### Problemas Identificados:

##### Problema 1: Exige autentica√ß√£o
```tsx
// src/pages/Filiacao.tsx (linha 58)
if (!user) {
  navigate('/login');  // ‚ùå ERRADO
  return;
}
```

##### Problema 2: Hook tamb√©m exige autentica√ß√£o
```tsx
// src/hooks/useFiliacaoPayment.ts (linha 73)
if (!user?.id) {
  throw new Error('Usu√°rio n√£o autenticado');  // ‚ùå ERRADO
}
```

##### Problema 3: Cria cobran√ßa √öNICA ao inv√©s de ASSINATURA
```tsx
// src/hooks/useFiliacaoPayment.ts (linha 107-120)
switch (data.payment_method) {
  case 'pix':
    paymentResult = await createPixPayment.mutateAsync({
      customer: customer.id,
      billingType: 'PIX',
      value: finalPrice,
      // ‚ùå FALTANDO: cycle, nextDueDate (campos de assinatura)
    });
    break;
}
```

**Tipo de cobran√ßa:** √öNICA (deveria ser ASSINATURA)

---

## üéØ FLUXO CORRETO PARA FILIA√á√ÉO COM ASSINATURA

### Baseado na Documenta√ß√£o Asaas:

```
1. Usu√°rio acessa /filiacao (SEM login) ‚úÖ
   ‚Üì
2. Seleciona tipo de membro ‚úÖ
   ‚Üì
3. Seleciona periodicidade (Mensal/Semestral/Anual) ‚ùå FALTANDO
   ‚Üì
4. Clica em "Prosseguir" ‚úÖ
   ‚Üì
5. Preenche formul√°rio COMPLETO:
   - Dados pessoais ‚úÖ
   - Endere√ßo ‚úÖ
   - Dados ministeriais ‚úÖ
   - SENHA ‚ùå FALTANDO
   - Forma de pagamento ‚úÖ
   - Dados do cart√£o (se cart√£o) ‚úÖ
   ‚Üì
6. Sistema CRIA CONTA no Supabase Auth ‚ùå FALTANDO
   ‚Üì
7. Sistema cria CLIENTE no Asaas ‚úÖ
   ‚Üì
8. Sistema cria ASSINATURA no Asaas ‚ùå FALTANDO
   (n√£o cobran√ßa √∫nica!)
   ‚Üì
9. Asaas gera PRIMEIRA COBRAN√áA automaticamente ‚úÖ
   ‚Üì
10. Sistema processa pagamento da primeira cobran√ßa ‚úÖ
    ‚Üì
11. Sistema cria perfil no banco ‚úÖ
    ‚Üì
12. Sistema cria registro de assinatura (user_subscriptions) ‚úÖ
    ‚Üì
13. Webhook PAYMENT_CREATED ativa assinatura ‚ùå FALTANDO
    ‚Üì
14. Redireciona para /auth com mensagem ‚ùå FALTANDO
    ‚Üì
15. Usu√°rio faz login pela primeira vez ‚ùå FALTANDO
```

---

## üìã DIFEREN√áAS CR√çTICAS

### Solicita√ß√£o de Servi√ßos (Correto):
| Aspecto | Implementa√ß√£o |
|---------|---------------|
| Tipo de cobran√ßa | ‚úÖ √önica (correto para servi√ßos) |
| Autentica√ß√£o | ‚úÖ Exige login (correto) |
| Checkout | ‚úÖ Transparente |
| Fluxo | ‚úÖ Completo |

### Filia√ß√£o (Incorreto):
| Aspecto | Implementa√ß√£o | Deveria ser |
|---------|---------------|-------------|
| Tipo de cobran√ßa | ‚ùå √önica | ‚úÖ Assinatura recorrente |
| Autentica√ß√£o | ‚ùå Exige login | ‚úÖ Criar conta durante processo |
| Sele√ß√£o de periodicidade | ‚ùå N√£o tem | ‚úÖ Mensal/Semestral/Anual |
| Campo senha | ‚ùå N√£o tem | ‚úÖ Obrigat√≥rio |
| Webhook handler | ‚ùå N√£o tem | ‚úÖ Ativar assinatura |

---

## üîß API ASAAS - ENDPOINTS NECESS√ÅRIOS

### Para Filia√ß√£o (Assinatura):

#### 1. Criar Cliente
```
POST /v3/customers
```
‚úÖ J√Å IMPLEMENTADO em `useAsaasCustomers`

#### 2. Criar Assinatura (N√ÉO cobran√ßa √∫nica!)
```
POST /v3/subscriptions
```
‚ùå N√ÉO IMPLEMENTADO

**Payload necess√°rio:**
```json
{
  "customer": "cus_000005401977",
  "billingType": "CREDIT_CARD",
  "value": 8.00,
  "nextDueDate": "2025-01-15",
  "cycle": "MONTHLY",  // ou QUARTERLY, SEMIANNUALLY, YEARLY
  "description": "Filia√ß√£o COMADEMIG - Di√°cono",
  "creditCard": {
    "holderName": "Jo√£o Silva",
    "number": "5162306219378829",
    "expiryMonth": "05",
    "expiryYear": "2026",
    "ccv": "318"
  },
  "creditCardHolderInfo": {
    "name": "Jo√£o Silva",
    "email": "joao@email.com",
    "cpfCnpj": "12345678900",
    "postalCode": "30000000",
    "addressNumber": "123",
    "phone": "31999999999"
  }
}
```

**Resposta:**
```json
{
  "object": "subscription",
  "id": "sub_000005401977",
  "customer": "cus_000005401977",
  "billingType": "CREDIT_CARD",
  "value": 8.00,
  "nextDueDate": "2025-01-15",
  "cycle": "MONTHLY",
  "status": "ACTIVE"
}
```

#### 3. Webhook de Cobran√ßa
```
POST /webhook (configurado no Asaas)
```
‚úÖ J√Å IMPLEMENTADO em `supabase/functions/asaas-webhook`

**Payload recebido:**
```json
{
  "event": "PAYMENT_CREATED",
  "payment": {
    "id": "pay_123",
    "subscription": "sub_000005401977",  // ‚Üê ID da assinatura
    "customer": "cus_000005401977",
    "value": 8.00,
    "status": "PENDING"
  }
}
```

---

## üÜö COMPARA√á√ÉO: Cobran√ßa √önica vs Assinatura

### Cobran√ßa √önica (Solicita√ß√£o de Servi√ßos):
```json
POST /v3/payments
{
  "customer": "cus_123",
  "billingType": "PIX",
  "value": 50.00,
  "dueDate": "2025-01-15"
}
```
**Resultado:** 1 cobran√ßa criada, paga 1 vez, acabou.

### Assinatura (Filia√ß√£o):
```json
POST /v3/subscriptions
{
  "customer": "cus_123",
  "billingType": "CREDIT_CARD",
  "value": 8.00,
  "nextDueDate": "2025-01-15",
  "cycle": "MONTHLY"
}
```
**Resultado:** 
- 1¬™ cobran√ßa criada automaticamente (vence em 15/01)
- 2¬™ cobran√ßa criada automaticamente (vence em 15/02)
- 3¬™ cobran√ßa ser√° criada automaticamente 40 dias antes
- Continua at√© cancelar a assinatura

---

## üìä HOOKS NECESS√ÅRIOS

### ‚úÖ J√Å EXISTEM:
- `useAsaasCustomers` - Criar cliente
- `useAsaasPixPayments` - Pagamento PIX
- `useAsaasCardPayments` - Pagamento Cart√£o
- `useAsaasBoletoPayments` - Pagamento Boleto

### ‚ùå FALTAM:
- `useAsaasSubscriptions` - Criar/gerenciar assinaturas
- `useSubscriptionWebhook` - Processar webhooks de assinatura

---

## üéØ CORRE√á√ïES NECESS√ÅRIAS

### 1. Criar hook useAsaasSubscriptions

**Arquivo:** `src/hooks/useAsaasSubscriptions.ts` (CRIAR)

```typescript
export function useAsaasSubscriptions() {
  const createSubscription = useMutation({
    mutationFn: async (data: {
      customer: string;
      billingType: 'CREDIT_CARD' | 'BOLETO' | 'PIX';
      value: number;
      nextDueDate: string;
      cycle: 'MONTHLY' | 'QUARTERLY' | 'SEMIANNUALLY' | 'YEARLY';
      description: string;
      creditCard?: {...};
      creditCardHolderInfo?: {...};
    }) => {
      const response = await fetch(`${ASAAS_BASE_URL}/subscriptions`, {
        method: 'POST',
        headers: {
          'access_token': ASAAS_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      return response.json();
    }
  });
  
  return { createSubscription };
}
```

### 2. Atualizar useFiliacaoPayment

**Arquivo:** `src/hooks/useFiliacaoPayment.ts`

**Mudan√ßas:**
- ‚ùå Remover verifica√ß√£o `if (!user?.id)`
- ‚úÖ Criar conta no Supabase Auth
- ‚ùå Remover `createPixPayment` / `processCardPayment`
- ‚úÖ Usar `createSubscription` ao inv√©s de cobran√ßa √∫nica
- ‚úÖ Passar `cycle` baseado na periodicidade selecionada

### 3. Adicionar sele√ß√£o de periodicidade

**Arquivo:** `src/components/public/MemberTypeSelector.tsx`

**Adicionar:**
- Radio buttons para cada plano (Mensal/Semestral/Anual)
- Estado para plano selecionado
- Passar plano selecionado para componente pai

### 4. Adicionar campo de senha

**Arquivo:** `src/components/payments/PaymentFormEnhanced.tsx`

**Adicionar:**
- Campo `password`
- Campo `password_confirmation`
- Valida√ß√£o Zod

### 5. Processar webhook de assinatura

**Arquivo:** `supabase/functions/asaas-webhook/index.ts`

**Adicionar:**
- Detectar `payment.subscription` no webhook
- Ativar assinatura em `user_subscriptions` quando pagamento confirmado
- Atualizar `expires_at` baseado no `cycle`

---

## üìù MAPEAMENTO: Periodicidade ‚Üí Cycle

| Periodicidade (Frontend) | Cycle (Asaas) | Dura√ß√£o |
|--------------------------|---------------|---------|
| Mensal | `MONTHLY` | 1 m√™s |
| Semestral | `SEMIANNUALLY` | 6 meses |
| Anual | `YEARLY` | 12 meses |

---

## ‚úÖ RESUMO EXECUTIVO

### O que est√° CORRETO:
- ‚úÖ M√≥dulo de Solicita√ß√£o de Servi√ßos (checkout transparente)
- ‚úÖ Cria√ß√£o de cliente no Asaas
- ‚úÖ Processamento de pagamento √∫nico
- ‚úÖ Webhook handler b√°sico

### O que est√° ERRADO:
- ‚ùå Filia√ß√£o exige login (deveria criar conta)
- ‚ùå Filia√ß√£o cria cobran√ßa √∫nica (deveria criar assinatura)
- ‚ùå N√£o tem sele√ß√£o de periodicidade
- ‚ùå N√£o tem campo de senha
- ‚ùå N√£o tem hook de assinaturas
- ‚ùå Webhook n√£o processa assinaturas

### Impacto:
- üî¥ **CR√çTICO:** Filia√ß√£o n√£o funciona (404)
- üî¥ **CR√çTICO:** Mesmo se funcionasse, n√£o seria recorrente
- üî¥ **CR√çTICO:** Usu√°rio n√£o consegue criar conta
- üü° **IMPORTANTE:** N√£o tem renova√ß√£o autom√°tica
- üü° **IMPORTANTE:** N√£o tem cobran√ßa mensal/semestral/anual

---

**AGUARDANDO AUTORIZA√á√ÉO PARA IMPLEMENTAR CORRE√á√ïES**
