# Sistema de Tipos de Membro e Assinaturas - COMADEMIG\n\n## üìã Vis√£o Geral\n\nEste documento descreve o sistema completo de tipos de membro e assinaturas implementado no portal COMADEMIG. O sistema permite a gest√£o din√¢mica de cargos ministeriais, planos de assinatura personalizados e integra√ß√£o autom√°tica com o processo de filia√ß√£o.\n\n## üéØ Objetivos\n\n- **Flexibilidade**: Substituir tipos de membro hardcoded por sistema din√¢mico\n- **Personaliza√ß√£o**: Permitir cria√ß√£o de planos de assinatura com permiss√µes espec√≠ficas\n- **Automa√ß√£o**: Integrar cria√ß√£o de assinaturas com processo de filia√ß√£o\n- **Auditoria**: Rastrear todas as opera√ß√µes do sistema\n- **Performance**: Otimizar queries e cache para melhor experi√™ncia\n\n## üèóÔ∏è Arquitetura do Sistema\n\n### Estrutura de Banco de Dados\n\n#### Tabelas Principais\n\n1. **member_types** - Tipos de membro din√¢micos\n   ```sql\n   - id (UUID, PK)\n   - name (VARCHAR, NOT NULL)\n   - description (TEXT)\n   - is_active (BOOLEAN, DEFAULT true)\n   - sort_order (INTEGER, DEFAULT 0)\n   - created_at (TIMESTAMP)\n   - updated_at (TIMESTAMP)\n   ```\n\n2. **subscription_plans** - Planos de assinatura\n   ```sql\n   - id (UUID, PK)\n   - name (VARCHAR, NOT NULL)\n   - description (TEXT)\n   - price (DECIMAL(10,2), NOT NULL)\n   - recurrence (ENUM: monthly, semestral, annual)\n   - permissions (JSONB)\n   - is_active (BOOLEAN, DEFAULT true)\n   - sort_order (INTEGER, DEFAULT 0)\n   - created_at (TIMESTAMP)\n   - updated_at (TIMESTAMP)\n   ```\n\n3. **member_type_subscriptions** - Relacionamento N:N\n   ```sql\n   - id (UUID, PK)\n   - member_type_id (UUID, FK)\n   - subscription_plan_id (UUID, FK)\n   - created_at (TIMESTAMP)\n   ```\n\n4. **user_subscriptions** - Assinaturas ativas dos usu√°rios\n   ```sql\n   - id (UUID, PK)\n   - user_id (UUID, FK)\n   - subscription_plan_id (UUID, FK)\n   - member_type_id (UUID, FK)\n   - status (ENUM: active, inactive, pending, cancelled)\n   - start_date (TIMESTAMP)\n   - end_date (TIMESTAMP)\n   - payment_reference (VARCHAR)\n   - created_at (TIMESTAMP)\n   - updated_at (TIMESTAMP)\n   ```\n\n5. **member_system_audit** - Logs de auditoria\n   ```sql\n   - id (UUID, PK)\n   - table_name (VARCHAR, NOT NULL)\n   - operation (ENUM: INSERT, UPDATE, DELETE, LOGIN, LOGOUT, VIEW, DOWNLOAD)\n   - record_id (VARCHAR, NOT NULL)\n   - old_values (JSONB)\n   - new_values (JSONB)\n   - user_id (UUID)\n   - user_email (VARCHAR)\n   - ip_address (VARCHAR)\n   - user_agent (TEXT)\n   - created_at (TIMESTAMP)\n   ```\n\n#### √çndices de Performance\n\n```sql\n-- √çndices para member_types\nCREATE INDEX idx_member_types_active ON member_types(is_active);\nCREATE INDEX idx_member_types_sort ON member_types(sort_order);\n\n-- √çndices para subscription_plans\nCREATE INDEX idx_subscription_plans_active ON subscription_plans(is_active);\nCREATE INDEX idx_subscription_plans_price ON subscription_plans(price);\nCREATE INDEX idx_subscription_plans_recurrence ON subscription_plans(recurrence);\n\n-- √çndices para user_subscriptions\nCREATE INDEX idx_user_subscriptions_user ON user_subscriptions(user_id);\nCREATE INDEX idx_user_subscriptions_status ON user_subscriptions(status);\nCREATE INDEX idx_user_subscriptions_active ON user_subscriptions(user_id, status) WHERE status = 'active';\n\n-- √çndices para auditoria\nCREATE INDEX idx_audit_table_operation ON member_system_audit(table_name, operation);\nCREATE INDEX idx_audit_user_date ON member_system_audit(user_id, created_at);\nCREATE INDEX idx_audit_created_at ON member_system_audit(created_at DESC);\n```\n\n### Componentes Frontend\n\n#### Hooks Principais\n\n1. **useMemberTypes**\n   - Gerencia CRUD de tipos de membro\n   - Valida√ß√£o com Zod\n   - Cache inteligente\n   - Fallback para compatibilidade\n\n2. **useSubscriptionPlans**\n   - Gerencia CRUD de planos de assinatura\n   - Filtros din√¢micos por tipo de membro\n   - Formata√ß√£o de pre√ßos\n   - C√°lculo de descontos\n\n3. **useUserSubscriptions**\n   - Gerencia assinaturas de usu√°rios\n   - Verifica√ß√£o de permiss√µes\n   - Status de assinatura ativa\n\n4. **useUserPermissions**\n   - Verifica√ß√£o de permiss√µes baseada em assinatura\n   - Cache de permiss√µes\n   - Hooks auxiliares para verifica√ß√µes espec√≠ficas\n\n5. **useAuditLog**\n   - Registro de atividades\n   - Consulta de logs com filtros\n   - M√©tricas de auditoria\n\n6. **usePerformanceOptimization**\n   - Configura√ß√µes de cache otimizadas\n   - Pr√©-carregamento de dados cr√≠ticos\n   - Monitoramento de performance\n\n#### Componentes de Interface\n\n1. **MemberTypesManagement**\n   - Interface administrativa para tipos de membro\n   - Listagem, cria√ß√£o, edi√ß√£o e exclus√£o\n   - Estat√≠sticas e m√©tricas\n\n2. **SubscriptionsManagement**\n   - Interface administrativa para planos de assinatura\n   - Configura√ß√£o de permiss√µes\n   - Associa√ß√£o com tipos de membro\n\n3. **AuditLogViewer**\n   - Visualiza√ß√£o de logs de auditoria\n   - Filtros avan√ßados\n   - Exporta√ß√£o CSV\n\n4. **PaymentForm (Aprimorado)**\n   - Sele√ß√£o din√¢mica de cargo ministerial\n   - Filtro autom√°tico de planos dispon√≠veis\n   - Integra√ß√£o com cria√ß√£o de assinatura\n\n## üîÑ Fluxos de Processo\n\n### Fluxo de Filia√ß√£o\n\n1. **Usu√°rio acessa p√°gina de filia√ß√£o**\n   - Sistema carrega tipos de membro ativos\n   - Exibe formul√°rio com sele√ß√£o de cargo\n\n2. **Sele√ß√£o de cargo ministerial**\n   - Usu√°rio escolhe cargo no dropdown\n   - Sistema filtra planos dispon√≠veis para o cargo\n   - Exibe op√ß√µes de planos com pre√ßos e benef√≠cios\n\n3. **Sele√ß√£o de plano**\n   - Usu√°rio escolhe plano de assinatura\n   - Sistema atualiza valor do pagamento\n   - Exibe resumo do plano selecionado\n\n4. **Preenchimento de dados**\n   - Usu√°rio preenche dados pessoais\n   - Sistema valida dados em tempo real\n   - Aplica formata√ß√£o autom√°tica (CPF, telefone, etc.)\n\n5. **Processamento do pagamento**\n   - Sistema gera cobran√ßa via Asaas\n   - Cria assinatura com status 'pending'\n   - Registra atividade no log de auditoria\n\n6. **Confirma√ß√£o**\n   - Usu√°rio recebe confirma√ß√£o\n   - Sistema aguarda webhook de pagamento\n   - Assinatura √© ativada automaticamente\n\n### Fluxo de Gerenciamento Administrativo\n\n1. **Cria√ß√£o de Tipo de Membro**\n   - Admin acessa /dashboard/admin/member-types\n   - Preenche formul√°rio com valida√ß√£o\n   - Sistema salva e invalida cache relacionado\n\n2. **Cria√ß√£o de Plano de Assinatura**\n   - Admin acessa /dashboard/admin/subscriptions\n   - Configura permiss√µes e tipos permitidos\n   - Sistema valida e salva configura√ß√µes\n\n3. **Monitoramento**\n   - Admin visualiza logs em /dashboard/admin/audit-logs\n   - Filtra por opera√ß√£o, usu√°rio ou per√≠odo\n   - Exporta relat√≥rios em CSV\n\n## üîí Sistema de Permiss√µes\n\n### Permiss√µes Dispon√≠veis\n\n- **manage_events**: Gerenciar eventos\n- **manage_news**: Gerenciar not√≠cias\n- **manage_media**: Gerenciar m√≠dia\n\n### Verifica√ß√£o de Permiss√µes\n\n```typescript\n// Verificar permiss√£o espec√≠fica\nconst { hasPermission } = useUserPermissions();\nconst canManageEvents = hasPermission('manage_events');\n\n// Verificar m√∫ltiplas permiss√µes\nconst { hasAllPermissions } = useUserPermissions();\nconst canManageContent = hasAllPermissions(['manage_news', 'manage_media']);\n\n// Hook simplificado\nconst { hasPermission } = usePermission('manage_events');\n```\n\n## üìä Monitoramento e Auditoria\n\n### Eventos Auditados\n\n- **INSERT**: Cria√ß√£o de registros\n- **UPDATE**: Atualiza√ß√£o de registros\n- **DELETE**: Exclus√£o de registros\n- **LOGIN**: Login de usu√°rios\n- **LOGOUT**: Logout de usu√°rios\n- **VIEW**: Visualiza√ß√£o de p√°ginas\n- **DOWNLOAD**: Download de arquivos\n\n### Informa√ß√µes Registradas\n\n- Usu√°rio respons√°vel pela a√ß√£o\n- Timestamp da opera√ß√£o\n- IP e User Agent\n- Valores anteriores e novos (para UPDATE)\n- Metadados adicionais\n\n### Consulta de Logs\n\n```typescript\n// Buscar logs com filtros\nconst { useAuditLogs } = useAuditLog();\nconst { data: logs } = useAuditLogs({\n  table_name: 'member_types',\n  operation: 'UPDATE',\n  date_from: '2024-01-01',\n  date_to: '2024-12-31'\n});\n\n// Registrar atividade manual\nconst { logUserActivity } = useAuditLog();\nawait logUserActivity({\n  action: 'Visualizar carteira digital',\n  table_name: 'carteira_digital',\n  record_id: carteiraId\n});\n```\n\n## ‚ö° Otimiza√ß√µes de Performance\n\n### Configura√ß√µes de Cache\n\n```typescript\n// Dados est√°ticos (30min stale, 1h cache)\nconst staticConfig = {\n  staleTime: 30 * 60 * 1000,\n  cacheTime: 60 * 60 * 1000,\n  refetchOnWindowFocus: false\n};\n\n// Dados din√¢micos (2min stale, 10min cache)\nconst dynamicConfig = {\n  staleTime: 2 * 60 * 1000,\n  cacheTime: 10 * 60 * 1000,\n  refetchOnWindowFocus: true\n};\n```\n\n### Pr√©-carregamento\n\n```typescript\n// Pr√©-carregar dados cr√≠ticos no login\nconst { prefetchCriticalData } = usePerformanceOptimization();\nawait prefetchCriticalData(userId);\n```\n\n### Invalida√ß√£o Seletiva\n\n```typescript\n// Invalidar cache relacionado ap√≥s opera√ß√£o\nconst { invalidateRelatedCache } = usePerformanceOptimization();\ninvalidateRelatedCache('UPDATE', 'member_types', recordId);\n```\n\n## üß™ Testes\n\n### Estrutura de Testes\n\n```\nsrc/__tests__/\n‚îú‚îÄ‚îÄ hooks/\n‚îÇ   ‚îú‚îÄ‚îÄ useMemberTypes.test.ts\n‚îÇ   ‚îú‚îÄ‚îÄ useSubscriptionPlans.test.ts\n‚îÇ   ‚îî‚îÄ‚îÄ useUserSubscriptions.test.ts\n‚îú‚îÄ‚îÄ components/\n‚îÇ   ‚îú‚îÄ‚îÄ MemberTypesManagement.test.tsx\n‚îÇ   ‚îî‚îÄ‚îÄ SubscriptionsManagement.test.tsx\n‚îî‚îÄ‚îÄ utils/\n    ‚îî‚îÄ‚îÄ validation.test.ts\n```\n\n### Executar Testes\n\n```bash\n# Todos os testes\nnpm test\n\n# Testes espec√≠ficos\nnpm test -- --testPathPattern=useMemberTypes\n\n# Com cobertura\nnpm test -- --coverage\n```\n\n## üîß Valida√ß√µes\n\n### Schemas Zod\n\n```typescript\n// Validar tipo de membro\nconst memberType = memberTypeSchema.parse(data);\n\n// Validar plano de assinatura\nconst plan = subscriptionPlanSchema.parse(data);\n\n// Validar dados de perfil\nconst profile = profileSchema.parse(data);\n```\n\n### Utilit√°rios de Valida√ß√£o\n\n```typescript\n// Validar CPF\nconst isValidCPF = validateCPF('123.456.789-00');\n\n// Formatar telefone\nconst formatted = formatPhone('11999999999'); // (11) 99999-9999\n\n// Sanitizar string\nconst clean = sanitizeString('<script>alert(\"xss\")</script>');\n```\n\n## üöÄ Deploy e Configura√ß√£o\n\n### Vari√°veis de Ambiente\n\n```env\n# Supabase\nVITE_SUPABASE_URL=your_supabase_url\nVITE_SUPABASE_ANON_KEY=your_supabase_anon_key\n\n# Asaas (Pagamentos)\nVITE_ASAAS_API_KEY=your_asaas_api_key\nVITE_ASAAS_ENVIRONMENT=sandbox # ou production\n```\n\n### Comandos de Deploy\n\n```bash\n# Build para produ√ß√£o\nnpm run build\n\n# Deploy via Lovable\ngit push origin main\n\n# Executar migra√ß√µes\nsupabase db push\n```\n\n## üìà M√©tricas e Monitoramento\n\n### KPIs do Sistema\n\n- **Taxa de convers√£o de filia√ß√£o**: % de usu√°rios que completam o processo\n- **Tempo m√©dio de filia√ß√£o**: Tempo do in√≠cio ao pagamento\n- **Distribui√ß√£o de planos**: Quais planos s√£o mais escolhidos\n- **Performance de queries**: Tempo m√©dio de resposta\n- **Taxa de erro**: % de opera√ß√µes que falham\n\n### Dashboards\n\n- **Admin Dashboard**: M√©tricas gerais do sistema\n- **Audit Dashboard**: Logs e atividades\n- **Performance Dashboard**: M√©tricas de performance\n\n## üîç Troubleshooting\n\n### Problemas Comuns\n\n1. **Cache desatualizado**\n   - Solu√ß√£o: Invalidar cache manualmente ou aguardar expira√ß√£o\n\n2. **Permiss√µes n√£o aplicadas**\n   - Verificar se assinatura est√° ativa\n   - Confirmar configura√ß√£o de permiss√µes do plano\n\n3. **Queries lentas**\n   - Verificar √≠ndices no banco\n   - Analisar logs de performance\n\n4. **Erros de valida√ß√£o**\n   - Verificar schemas Zod\n   - Validar dados de entrada\n\n### Logs √öteis\n\n```typescript\n// Habilitar logs de desenvolvimento\nif (process.env.NODE_ENV === 'development') {\n  console.log('Query performance:', duration);\n}\n\n// Logs de auditoria\nconsole.log('Audit log created:', logEntry);\n```\n\n## üìö Refer√™ncias\n\n- [Documenta√ß√£o do Supabase](https://supabase.com/docs)\n- [React Query Documentation](https://tanstack.com/query/latest)\n- [Zod Validation](https://zod.dev/)\n- [Asaas API](https://docs.asaas.com/)\n\n## ü§ù Contribui√ß√£o\n\n### Padr√µes de C√≥digo\n\n- Use TypeScript para type safety\n- Siga conven√ß√µes de nomenclatura estabelecidas\n- Escreva testes para novas funcionalidades\n- Documente APIs p√∫blicas\n- Use Zod para valida√ß√£o de dados\n\n### Processo de Review\n\n1. Criar branch feature\n2. Implementar funcionalidade com testes\n3. Abrir Pull Request\n4. Code review\n5. Merge ap√≥s aprova√ß√£o\n\n---\n\n**Vers√£o**: 1.0.0  \n**√öltima atualiza√ß√£o**: 27/08/2024  \n**Autor**: Sistema COMADEMIG"