# Implementation Plan - Corre√ß√£o Sistema de Filia√ß√£o e Integra√ß√£o Asaas

## üìä LEGENDA DE STATUS
- `[ ]` = N√£o iniciado
- `[~]` = **Implementado mas N√ÉO testado/validado**
- `[x]` = Testado e validado pelo usu√°rio

## üìà PROGRESSO ATUAL
- **Total de tarefas:** 32
- **Implementadas:** 18 tarefas [~]
- **Validadas:** 1 tarefa [x] (Tarefa 20 - sem dados para migrar)
- **N√£o iniciadas:** 10 tarefas [ ]
- **Canceladas:** 3 tarefas (19-PIX, 21-22-23 antigas)
- **Progresso de implementa√ß√£o:** 56%
- **Progresso de valida√ß√£o:** 3%

## ‚ö†Ô∏è PR√ìXIMOS PASSOS CR√çTICOS
1. **Fase 6: Limpeza e Consolida√ß√£o** - Limpar tabelas duplicadas, migra√ß√µes com erro, arquivos tempor√°rios
2. **Aplicar migra√ß√µes no banco** via `supabase db push`
3. **Fase 7: Testes e Valida√ß√£o** - Testar fluxo completo de filia√ß√£o
4. **Configurar webhooks** no dashboard Asaas (manual)

## Fase 1: Corre√ß√µes Cr√≠ticas e Prepara√ß√£o do Banco

- [~] 1. Corrigir trigger sync_user_role_to_metadata
  - ‚úÖ Migra√ß√£o criada: `20251014000001_fix_triggers_and_foreign_keys.sql`
  - ‚úÖ Trigger removido (causava deadlock)
  - ‚úÖ Trigger handle_new_user corrigido com tratamento de erro
  - ‚úÖ Foreign key profiles_id_fkey tornada DEFERRABLE
  - ‚úÖ Trigger audit_profiles corrigido para n√£o bloquear DELETE
  - ‚ö†Ô∏è **PENDENTE:** Testar cadastro de novo usu√°rio
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [~] 2. Criar tabela webhook_events
  - ‚úÖ Migra√ß√£o criada: `20251016044919_update_webhook_events_structure.sql`
  - ‚úÖ Estrutura completa com campos: id, asaas_event_id, event_type, payload, processed, etc
  - ‚úÖ √çndices para performance adicionados
  - ‚úÖ RLS policies criadas (apenas service_role)
  - ‚ö†Ô∏è **PENDENTE:** Verificar tabela no banco via SQL
  - _Requirements: 4.1, 4.7_

- [~] 3. Atualizar tabela user_subscriptions
  - ‚úÖ Migra√ß√£o criada: `20251016042413_update_user_subscriptions_fields.sql`
  - ‚úÖ Campos adicionados: initial_payment_id, asaas_customer_id, billing_type, cycle, value
  - ‚úÖ Constraint para status adicionado
  - ‚úÖ √çndices necess√°rios criados
  - ‚ö†Ô∏è **PENDENTE:** Verificar estrutura no banco via SQL
  - _Requirements: 2.1, 2.2, 2.4_

- [~] 4. Atualizar tabela asaas_splits
  - ‚úÖ Migra√ß√£o criada: `20251016045536_update_asaas_splits_structure.sql`
  - ‚úÖ Campos adicionados: subscription_id, payment_id, status, refusal_reason
  - ‚úÖ Constraints e foreign keys atualizados
  - ‚úÖ √çndices para queries frequentes criados
  - ‚ö†Ô∏è **PENDENTE:** Verificar estrutura no banco via SQL
  - _Requirements: 3.1, 3.6_

- [~] 5. Corrigir RLS policies
  - ‚úÖ Migra√ß√£o criada: `20251016050646_fix_rls_policies_security.sql`
  - ‚úÖ Policy de asaas_customers atualizada (removido authenticated)
  - ‚úÖ Policies restritivas para user_subscriptions criadas
  - ‚úÖ Policies para asaas_splits criadas
  - ‚ö†Ô∏è **PENDENTE:** Testar com diferentes roles (user, admin, service_role)
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

## Fase 2: Implementa√ß√£o do Sistema de Split

- [~] 6. Criar fun√ß√£o getSplitConfiguration
  - ‚úÖ Arquivo criado: `supabase/functions/shared/split-config.ts`
  - ‚úÖ Fun√ß√£o getSplitConfiguration implementada
  - ‚úÖ Busca wallet_id da RENUM e COMADEMIG (vari√°veis de ambiente)
  - ‚úÖ Busca wallet_id do afiliado (se c√≥digo fornecido)
  - ‚úÖ Calcula percentuais: 40%+40%+20% (com afiliado) ou 50%+50% (sem afiliado)
  - ‚úÖ Retorna array de splits formatado para Asaas
  - ‚úÖ Valida√ß√£o de soma de percentuais (100%)
  - ‚ö†Ô∏è **PENDENTE:** Testar com c√≥digo de afiliado real
  - _Requirements: 3.1, 3.2, 3.3_

- [~] 7. Refatorar Edge Function asaas-create-subscription
  - ‚úÖ Arquivo: `supabase/functions/asaas-create-subscription/index.ts`
  - ‚úÖ Par√¢metro affiliateCode adicionado na interface
  - ‚úÖ Chama getSplitConfiguration antes de criar subscription
  - ‚úÖ Cria cobran√ßa imediata (initial payment) com split
  - ‚úÖ Cria assinatura com split e nextDueDate = hoje + 30 dias
  - ‚úÖ Salva dados em user_subscriptions
  - ‚úÖ Registra splits em asaas_splits
  - ‚úÖ Retorna IDs de subscription e initial payment
  - ‚ö†Ô∏è **PENDENTE:** Testar fluxo completo de filia√ß√£o
  - _Requirements: 3.4, 3.5, 8.1, 8.2, 8.3, 8.4, 8.7_



- [~] 8. Adicionar valida√ß√£o de c√≥digo de afiliado
  - ‚úÖ Hook criado: `src/hooks/useReferralCode.ts`
  - ‚úÖ Valida c√≥digo automaticamente da URL (?ref=CODIGO)
  - ‚úÖ Busca dados do afiliado (id, display_name, wallet_id)
  - ‚úÖ Salva no localStorage para persistir durante cadastro
  - ‚úÖ Valida√ß√£o silenciosa (sem alertas visuais)
  - ‚ö†Ô∏è **PENDENTE:** Testar com link de afiliado real
  - _Requirements: 5.1, 5.2, 6.6_

- [~] 9. Adicionar logs estruturados
  - ‚úÖ Arquivo criado: `supabase/functions/shared/logger.ts`
  - ‚úÖ Fun√ß√£o logSubscriptionCreation implementada
  - ‚úÖ Loga cria√ß√£o de subscription com todos os par√¢metros
  - ‚úÖ Loga configura√ß√£o de split (walletIds, percentuais)
  - ‚úÖ Loga erros com stack trace completo
  - ‚ö†Ô∏è **PENDENTE:** Verificar logs no Supabase Dashboard
  - _Requirements: 10.1, 10.3, 10.4_

## Fase 3: Implementa√ß√£o de Webhooks

- [~] 10. Criar Edge Function asaas-webhook
  - ‚úÖ Arquivo criado: `supabase/functions/asaas-webhook/index.ts`
  - ‚úÖ Estrutura b√°sica da fun√ß√£o implementada
  - ‚úÖ Valida√ß√£o de autenticidade (asaas-access-token)
  - ‚úÖ Verifica√ß√£o de idempot√™ncia (asaas_event_id)
  - ‚úÖ Salva evento em webhook_events
  - ‚ö†Ô∏è **PENDENTE:** Testar recebimento de webhook real
  - _Requirements: 4.1, 4.7_

- [~] 11. Implementar processamento de PAYMENT_RECEIVED
  - ‚úÖ Implementado em `asaas-webhook/index.ts`
  - ‚úÖ Busca subscription pelo asaas_subscription_id
  - ‚úÖ Atualiza status de 'pending' para 'active'
  - ‚úÖ Atualiza started_at se for primeiro pagamento
  - ‚úÖ Loga evento processado
  - ‚ö†Ô∏è **PENDENTE:** Testar com webhook real do Asaas
  - _Requirements: 4.2, 8.5_

- [~] 12. Implementar processamento de PAYMENT_CONFIRMED
  - ‚úÖ Implementado em `asaas-webhook/index.ts`
  - ‚úÖ Registra confirma√ß√£o do pagamento
  - ‚úÖ Atualiza dados financeiros se necess√°rio
  - ‚úÖ Loga evento processado
  - ‚ö†Ô∏è **PENDENTE:** Testar com webhook real do Asaas
  - _Requirements: 4.3_

- [~] 13. Implementar processamento de PAYMENT_OVERDUE
  - ‚úÖ Implementado em `asaas-webhook/index.ts`
  - ‚úÖ Atualiza status para 'overdue'
  - ‚úÖ Cria notifica√ß√£o para usu√°rio
  - ‚úÖ Loga evento processado
  - ‚ö†Ô∏è **PENDENTE:** Testar com webhook real do Asaas
  - _Requirements: 4.4_

- [~] 14. Implementar processamento de eventos de split
  - ‚úÖ Implementado em `asaas-webhook/index.ts`
  - ‚úÖ Atualiza status em asaas_splits
  - ‚úÖ Registra comiss√£o em affiliate_commissions
  - ‚úÖ Loga evento processado
  - ‚ö†Ô∏è **PENDENTE:** Testar com webhook real de split
  - _Requirements: 4.6, 5.6_

- [~] 15. Implementar retry de webhooks falhados
  - ‚úÖ Arquivo criado: `supabase/functions/retry-failed-webhooks/index.ts`
  - ‚úÖ Fun√ß√£o para reprocessar webhooks com erro
  - ‚úÖ Backoff exponencial implementado
  - ‚úÖ Limite de 5 tentativas
  - ‚úÖ Registra em webhook_errors ap√≥s falhas
  - ‚ö†Ô∏è **PENDENTE:** Testar retry com webhook falhado
  - _Requirements: 4.7, 10.6_

## Fase 4: Refatora√ß√£o do Frontend

- [~] 16. Refatorar hook useFiliacaoPayment
  - ‚úÖ Arquivo: `src/hooks/useFiliacaoPayment.ts`
  - ‚úÖ Removida chamada para asaas-configure-split (obsoleta)
  - ‚úÖ Passa affiliateInfo para asaas-create-subscription
  - ‚úÖ Aguarda confirma√ß√£o de split na resposta
  - ‚úÖ Salva initial_payment_id em user_subscriptions
  - ‚úÖ Tratamento de erros melhorado
  - ‚ö†Ô∏è **PENDENTE:** Testar fluxo completo de filia√ß√£o
  - _Requirements: 8.1, 8.2, 8.3, 8.7_

- [~] 17. Implementar valida√ß√£o de afiliado no frontend
  - ‚úÖ Hook `useReferralCode` implementado
  - ‚úÖ Captura autom√°tica de c√≥digo da URL (?ref=CODIGO)
  - ‚úÖ Valida√ß√£o silenciosa (sem alertas visuais)
  - ‚úÖ Salva no localStorage para persistir
  - ‚úÖ Integrado em `Filiacao.tsx`
  - ‚úÖ Removido campo manual de c√≥digo (discreto)
  - ‚ö†Ô∏è **PENDENTE:** Testar com link de afiliado real
  - _Requirements: 5.1, 5.2, 6.6_

- [~] 18. Melhorar tratamento de erros
  - ‚úÖ Arquivo criado: `src/utils/errorMessages.ts`
  - ‚úÖ Mapeamento completo de erros do Asaas
  - ‚úÖ Mensagens amig√°veis por tipo de erro
  - ‚úÖ Hook `useRetry` com backoff exponencial
  - ‚úÖ Componente `ErrorAlert` para exibi√ß√£o
  - ‚úÖ Integrado em `useFiliacaoPayment`
  - ‚ö†Ô∏è **PENDENTE:** Testar com erros reais (cart√£o recusado, CPF duplicado)
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

- [ ] 19. Remover valida√ß√£o restritiva de PIX
  - ‚ùå **TAREFA CANCELADA** - Decis√£o: manter apenas Cart√£o de Cr√©dito
  - ‚úÖ Valida√ß√£o mantida: apenas CREDIT_CARD para filia√ß√µes
  - ‚úÖ PIX dispon√≠vel para outros servi√ßos (certid√µes, regulariza√ß√µes)
  - _Requirements: N/A - Requisito n√£o ser√° implementado_

## Fase 5: Migra√ß√£o de Dados e Limpeza

- [x] 20. Migrar dados de asaas_subscriptions para user_subscriptions

  - ‚úÖ An√°lise realizada: ambas tabelas vazias (0 registros)
  - ‚úÖ Nenhum dado para migrar
  - ‚úÖ Fun√ß√£o de migra√ß√£o criada para uso futuro (se necess√°rio)
  - _Requirements: 2.5_

- [ ] ~~21. Marcar asaas_subscriptions como deprecated~~
  - ‚ùå **CANCELADA** - Ser√° tratada na Fase 6 (Limpeza)

- [ ] ~~22. Configurar webhooks no Asaas~~
  - ‚ùå **CANCELADA** - Requer acesso manual (n√£o √© tarefa de c√≥digo)

- [ ] ~~23. Criar dashboard de monitoramento~~
  - ‚ùå **CANCELADA** - Ser√° tratada ap√≥s valida√ß√£o do sistema

## Fase 6: Limpeza e Consolida√ß√£o do Sistema

- [x] 21. Analisar e consolidar tabelas de servi√ßos



  - Identificar tabelas duplicadas: servico_assinantes, servicos, servicos_regularizacao, solicitacoes_servicos
  - Verificar qual tabela est√° realmente em uso no c√≥digo
  - Mapear refer√™ncias no frontend e backend
  - Documentar prop√≥sito de cada tabela
  - _Requirements: Limpeza t√©cnica_

- [x] 22. Deprecar/remover tabelas n√£o utilizadas




  - Marcar tabelas obsoletas como DEPRECATED
  - Criar migra√ß√£o para remover tabelas n√£o utilizadas
  - Atualizar tipos TypeScript
  - Remover refer√™ncias no c√≥digo
  - _Requirements: Limpeza t√©cnica_

- [ ] 23. Limpar diret√≥rio de migra√ß√µes




  - Identificar migra√ß√µes com erro que n√£o foram aplicadas
  - Remover arquivos de migra√ß√£o duplicados ou obsoletos
  - Documentar migra√ß√µes que devem ser mantidas
  - Criar backup antes de remover
  - _Requirements: Organiza√ß√£o_

- [x] 24. Limpar arquivos tempor√°rios e de an√°lise

  - Remover scripts Python de an√°lise tempor√°rios
  - Remover arquivos .md de documenta√ß√£o duplicada
  - Limpar arquivos de teste n√£o utilizados
  - Manter apenas documenta√ß√£o essencial
  - _Requirements: Organiza√ß√£o_

- [x] 25. Consolidar documenta√ß√£o



  - Criar documento √∫nico de arquitetura do sistema
  - Documentar estrutura final de tabelas
  - Documentar fluxos principais (filia√ß√£o, pagamento, webhook)
  - Remover documentos redundantes
  - _Requirements: Documenta√ß√£o_

## Fase 7: Testes e Valida√ß√£o

- [x] 26. Testar fluxo completo de filia√ß√£o sem afiliado




  - Criar novo usu√°rio
  - Verificar cobran√ßa imediata criada
  - Verificar assinatura criada com nextDueDate correto
  - Verificar split configurado (50% RENUM + 50% COMADEMIG)
  - Simular webhook de pagamento
  - Verificar status atualizado para 'active'
  - _Requirements: 3.2, 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 27. Testar fluxo completo de filia√ß√£o com afiliado
  - Criar novo usu√°rio com c√≥digo de referral
  - Verificar afiliado validado e exibido
  - Verificar split configurado (40% RENUM + 40% COMADEMIG + 20% Afiliado)
  - Simular webhook de pagamento
  - Verificar comiss√£o registrada em affiliate_commissions
  - _Requirements: 3.3, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ] 28. Testar todos os m√©todos de pagamento
  - Testar PIX em plano mensal
  - Testar PIX em plano semestral
  - Testar PIX em plano anual
  - Testar cart√£o em todos os planos
  - Verificar desconto de 5% aplicado no PIX
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 29. Testar tratamento de erros
  - Testar CPF duplicado
  - Testar email duplicado
  - Testar cart√£o inv√°lido
  - Testar c√≥digo de afiliado inv√°lido
  - Verificar mensagens de erro espec√≠ficas
  - _Requirements: 6.1, 6.2, 6.3, 6.6_

- [ ] 30. Testar webhooks
  - Enviar webhook de teste para cada tipo de evento
  - Verificar processamento correto
  - Testar idempot√™ncia (enviar mesmo evento 2x)
  - Testar retry em caso de falha
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.6, 4.7_

- [ ] 31. Testar seguran√ßa
  - Tentar acessar dados de outro usu√°rio (deve falhar)
  - Tentar modificar asaas_customers como usu√°rio comum (deve falhar)
  - Verificar que admin v√™ todos os dados
  - Verificar que super_admin n√£o pode ser deletado
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

- [ ] 32. Valida√ß√£o final e documenta√ß√£o
  - Revisar todos os requisitos atendidos
  - Atualizar documenta√ß√£o t√©cnica
  - Criar guia de troubleshooting
  - Documentar configura√ß√µes necess√°rias
  - Preparar plano de rollback
  - _Requirements: Todos_


---

## üîí CHECKLIST DE VALIDA√á√ÉO OBRIGAT√ìRIA

### Antes de marcar qualquer tarefa como [x], verificar:

#### Para Migra√ß√µes de Banco (Tarefas 1-5):
- [ ] Migra√ß√£o aplicada no banco via `supabase db push`
- [ ] Estrutura verificada via `supabase db execute "SELECT ..."`
- [ ] Dados de teste inseridos com sucesso
- [ ] Pol√≠ticas RLS testadas com diferentes roles
- [ ] Nenhum erro no console do Supabase

#### Para Edge Functions (Tarefas 6-15):
- [ ] Function deployada via `supabase functions deploy nome`
- [ ] Logs verificados via `supabase functions logs nome`
- [ ] Testada com dados reais via Postman/cURL
- [ ] Resposta correta recebida
- [ ] Dados persistidos no banco

#### Para Frontend (Tarefas 16-18):
- [ ] C√≥digo compilando sem erros
- [ ] P√°gina acess√≠vel no navegador
- [ ] Formul√°rio renderizando corretamente
- [ ] Intera√ß√µes funcionando (cliques, inputs)
- [ ] Dados sendo enviados corretamente
- [ ] Feedback visual adequado (loading, success, error)

#### Para Fluxo Completo (Tarefas 24-25):
- [ ] Novo usu√°rio criado com sucesso
- [ ] Pagamento processado
- [ ] Assinatura criada no Asaas
- [ ] Splits configurados
- [ ] Dados salvos no banco
- [ ] Usu√°rio ativado
- [ ] Webhook recebido e processado

---

## üìã RELAT√ìRIO DE IMPLEMENTA√á√ÉO

### ‚úÖ Arquivos Criados/Modificados:

#### Migra√ß√µes SQL:
1. `supabase/migrations/20251014000001_fix_triggers_and_foreign_keys.sql`
2. `supabase/migrations/20251016042413_update_user_subscriptions_fields.sql`
3. `supabase/migrations/20251016044919_update_webhook_events_structure.sql`
4. `supabase/migrations/20251016045536_update_asaas_splits_structure.sql`
5. `supabase/migrations/20251016050646_fix_rls_policies_security.sql`

#### Edge Functions:
1. `supabase/functions/asaas-create-subscription/index.ts` (refatorado)
2. `supabase/functions/asaas-webhook/index.ts` (novo)
3. `supabase/functions/retry-failed-webhooks/index.ts` (novo)
4. `supabase/functions/shared/split-config.ts` (novo)
5. `supabase/functions/shared/logger.ts` (novo)

#### Frontend - Hooks:
1. `src/hooks/useFiliacaoPayment.ts` (refatorado)
2. `src/hooks/useReferralCode.ts` (atualizado)
3. `src/hooks/useRetry.ts` (novo)

#### Frontend - Componentes:
1. `src/components/payments/PaymentFormEnhanced.tsx` (refatorado)
2. `src/components/ui/error-alert.tsx` (novo)
3. `src/pages/Filiacao.tsx` (refatorado)

#### Frontend - Utilit√°rios:
1. `src/utils/errorMessages.ts` (novo)

### ‚ùå Arquivos Removidos (Limpeza):
1. `src/components/payments/AffiliateCodeInput.tsx` (n√£o usado)
2. `src/hooks/useAffiliateValidation.ts` (n√£o usado)
3. `supabase/functions/validate-affiliate-code/index.ts` (n√£o usado)

---

## ‚ö†Ô∏è A√á√ïES NECESS√ÅRIAS PARA VALIDA√á√ÉO

### 1. Aplicar Migra√ß√µes no Banco
```powershell
supabase db push
```

### 2. Deploy de Edge Functions
```powershell
supabase functions deploy asaas-create-subscription
supabase functions deploy asaas-webhook
supabase functions deploy retry-failed-webhooks
```

### 3. Configurar Vari√°veis de Ambiente
```powershell
supabase secrets set RENUM_WALLET_ID=valor
supabase secrets set COMADEMIG_WALLET_ID=valor
```

### 4. Testar Fluxo de Filia√ß√£o
- Acessar: http://localhost:8080/filiacao
- Preencher formul√°rio completo
- Processar pagamento com cart√£o de teste
- Verificar cria√ß√£o de assinatura
- Verificar splits configurados

### 5. Configurar Webhooks no Asaas
- Dashboard Asaas > Webhooks
- URL: https://[seu-projeto].supabase.co/functions/v1/asaas-webhook
- Token: [configurar secret]
- Eventos: PAYMENT_RECEIVED, PAYMENT_CONFIRMED, PAYMENT_OVERDUE, etc

---

## üéØ CRIT√âRIO PARA MARCAR [x]

**Uma tarefa S√ì ser√° marcada como [x] quando:**
1. ‚úÖ C√≥digo implementado
2. ‚úÖ Migra√ß√£o aplicada (se aplic√°vel)
3. ‚úÖ Function deployada (se aplic√°vel)
4. ‚úÖ Testada manualmente com sucesso
5. ‚úÖ Resultado documentado
6. ‚úÖ **Voc√™ validou e aprovou**

**Atualmente: 18 tarefas [~] aguardando valida√ß√£o**
